var assert = require('assert');
var net = require('net');
var nf = require('../lib/nodefly');
var should = require('should');

describe('Exit', function() {
	it('intercepts http upgrade events', function(next) {
		require('../').profile('deadbeef', 'deadbeef');
		require('http').createServer().listen(0, function() {
			var server = this;
			assert.equal(nf.server_obj, server);
			assert.equal(nf.server_obj.connCount, 0);
			server.on('request', assert.fail);
			server.on('upgrade', function() {
				assert.equal(nf.server_obj.connCount, 1);
				next();
			});
			net.createConnection(server.address().port, function() {
				this.write(
					'GET / HTTP/1.1\r\n' +
					'Upgrade: Yes, please.\r\n' +
					'\r\n');
				this.destroySoon();
			});
		});
	});
});

